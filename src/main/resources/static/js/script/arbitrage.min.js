let selectedSubscription={},purchaseLimit=$("#purchaseLimit").val();function purchase(e,i){let s={user:{id:currentUser.id},subscriptionPackage:{id:e}};$.blockUI(blockUiOptions()),$.postJSON("/api/v1/subscription/purchase",s,function(e){$.unblockUI(),null==e.error?(show_success(resources.saveSuccess),refreshSubscriptionPackages()):show_error(e.error)},function(e,s,t){$.unblockUI(),isNullOrEmpty(get(()=>e.responseJSON))?show_error("ajax answer post returned error: "+t.responseText):e.responseJSON.status>=400&&e.responseJSON.status<500?show_warning(e.responseJSON.error+" ("+e.responseJSON.status+") <br>"+e.responseJSON.message):show_error(e.responseJSON.error+" ("+e.responseJSON.status+") <br>"+e.responseJSON.message),406==e.responseJSON.status&&setTimeout(function(){loadPages("deposit?amount="+i)},5e3)})}function refreshSubscriptionPackages(){$("#subscription-package").empty(),$.getJSON("/api/v1/subscription-package?size=100&sort=price,asc&status=Active",function(e){$.get("/api/v1/subscription/find-active-by-user/"+currentUser.id,function(i){selectedSubscription=i,e.content.forEach(function(e){let s=get(()=>i.subscriptionPackage.price,0),t=`
                <div class="col-md-3 col-sm-6" id="subscription-package-item-${e.id}">
                    <div class="pricing">
                        <div class="title">
                            <h2>${e.name}</h2>
                            <h1>${addPeriod(e.price)} ${e.currency}</h1>
                        </div>
                        <div class="x_content">
                            <div class="">
                                <div class="pricing_features">
                                    <ul class="list-unstyled text-left">
                                        <li><i class="fa ${"Free"==e.name?"fa-times text-danger":"fa-check text-success"}"></i> Allow withdrawal.</li>
                                        <li><i class="fa fa-check text-success"></i> Order count <strong> ${e.orderCount}</strong> times</li>
                                        <li><i class="fa fa-check text-success"></i> Trading reward between range (<strong>${e.minTradingReward} - ${e.maxTradingReward}</strong>) ${e.currency}</li>
                                        <li><i class="fa fa-check text-success"></i> User profit percentage (<strong>${e.userProfitPercentage}%</strong>)</li>
                                        <li><i class="fa fa-check text-success"></i> Site profit percentage (<strong>${e.siteProfitPercentage}%</strong>)</li>
                                        <li><i class="fa fa-check text-success"></i> Will Expire in (<strong>${e.duration<0?'<i class="fa fa-infinity"></i>':e.duration}</strong>) days</li>
                                        <li><i class="fa fa-check text-success"></i> Parent referral bonus <strong>${e.parentReferralBonus}</strong> ${e.currency}</li>
                                        <li><i class="fa fa-check text-success"></i> Maximum acceptable amount <strong>${addPeriod(e.maxPrice)}</strong> ${e.currency}</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="pricing_footer">
                                <a id="trade-btn-${e.id}" href="javascript:trade(${e.id});" class="btn btn-success btn-block ${s!=e.price?"disabled":""}" aria-disabled="${s!=e.price}" role="button">Trade ${isNullOrEmpty(purchaseLimit)?"Now":purchaseLimit}</a> 
                                <a href="javascript:purchase(${e.id},${e.price});" class="btn btn-primary btn-block ${s>=e.price?"disabled":""}" aria-disabled="${s>=e.price}" role="button">Purchase<span></span></a>                          
                            </div>
                        </div>
                    </div>
                </div>`;$("#subscription-package").append(t)}),$("#trading-content").show(),$("#subscription-package-content .collapse-link").click(),trade(selectedSubscription.subscriptionPackage.id)})})}async function trade(e,i){if($("#trade-btn-"+e).attr("disabled","disabled").attr("aria-disabled",!0).addClass("disabled"),isNullOrEmpty(purchaseLimit=await (await fetch("/api/v1/arbitrage/purchase-limit/"+currentUser.id)).text()))$(`#subscription-package-item-${e} .btn-success`).text(resources.tradeNow);else{show_warning(`You have reached the purchase limitation, please try ${purchaseLimit}`),$(`#subscription-package-item-${e} .btn-success`).text("Trade "+purchaseLimit),$("#trading-order").html(`<div id="purchase-limit-notice" class="col-12 alert alert-warning">
                                    <button onclick="$('#purchase-limit-notice').hide()" class="close">&times;</button>
                                    <div class="alert-content">
                                        <i class="fa fa-warning" style="font-size:17px"></i>
                                        <ul style="margin: 0">
                                            <li>You have reached the purchase limitation, please try ${purchaseLimit}</li>                                           
                                        </ul>
                                    </div>
                                </div>`);return}isNullOrEmpty($("#selectedSubscription").val())||$("#trading-content").is(":visible")||($("#subscription-package-content .collapse-link").click(),$("#trading-content").show()),$("#trading-content .x_title h2 small").text(selectedSubscription.subscriptionPackage.name);let s=get(()=>selectedSubscription.subscriptionPackage.orderCount,0);if(s>0){$("#trading-order").empty();for(let t=0;t<s;t++){let a=await (await fetch("api/v1/coin/buy/"+currentUser.id)).json(),r=await (await fetch("api/v1/exchange/buy/"+currentUser.id)).json(),c=`
            <div class="col-md-3 widget widget_tally_box">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>Order ${t+1}</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">

                        <div style="text-align: center; margin-bottom: 17px">
                         <span id="order-${t+1}" class="chart" data-percent="100">
                              <span class="percent"></span>
                         </span>
                        </div>

                        <h3 class="name_title"><img width="40px" src="${a.logo}"/> ${a.name}</h3>
                        <p>From exchange <img width="20px" src="${r[0].logo}"/> ${r[0].name} to <img width="20px" src="${r[1].logo}"/> ${r[1].name}</p>

                        <div class="divider"></div>
                        <a id="buy-btn-${t+1}" href="javascript:buy(${t+1}, ${r[0].id}, ${a.id}, ${selectedSubscription.id});" class="btn btn-primary btn-block" role="button">Buy/Sell</a>
                    </div>
                </div>
            </div>`;$("#trading-order").append(c)}"function"==typeof i&&i()}$("#trade-btn-"+e).removeAttr("disabled").attr("aria-disabled",!1).removeClass("disabled")}function buy(e,i,s,t){$("#buy-btn-"+e).addClass("disabled").attr("aria-disabled","true"),$("#order-"+e).easyPieChart({easing:"easeOutElastic",delay:3e3,barColor:"#26B99A",trackColor:"#fff",scaleColor:!1,lineWidth:20,trackWidth:16,lineCap:"butt",onStep:function(e,i,s){$(this.el).find(".percent").text(Math.round(s))},onStop:function(a,r){console.log("Animation complete. Final percentage: "+r),$.postJSON("/api/v1/arbitrage",{user:{id:currentUser.id},exchange:{id:i},coin:{id:s},subscription:{id:t}},function(i){$("#buy-btn-"+e).after(`<p>You received ${i.reward} profit from this purchase at ${new Date(i.createdDate).toLocaleString()}</p>`),$("#buy-btn-"+e).remove()},function(i,s,t){isNullOrEmpty(get(()=>i.responseJSON))?show_error("ajax answer post returned error: "+t.responseText):i.responseJSON.status>=400&&i.responseJSON.status<500?show_warning(i.responseJSON.error+" ("+i.responseJSON.status+") <br>"+i.responseJSON.message):show_error(i.responseJSON.error+" ("+i.responseJSON.status+") <br>"+i.responseJSON.message),$("#buy-btn-"+e).after(`<p class="red">${i.responseJSON.message}</p>`),$("#buy-btn-"+e).remove()})},animate:{duration:(Math.floor(41*Math.random())+20)*1e3,enabled:!0}})}$(function(){isNullOrEmpty($("#selectedSubscription").val())||(selectedSubscription=JSON.parse($("#selectedSubscription").val()),$("#subscription-package-content .collapse-link").click()),isNullOrEmpty(purchaseLimit)||$("#trading-order").html(`<div id="purchase-limit-notice" class="col-12 alert alert-warning">
                                    <button onclick="$('#purchase-limit-notice').hide()" class="close">&times;</button>
                                    <div class="alert-content">
                                        <i class="fa fa-warning" style="font-size:17px"></i>
                                        <ul style="margin: 0">
                                            <li>You have reached the purchase limitation, please try ${purchaseLimit}</li>                                           
                                        </ul>
                                    </div>
                                </div>`)});